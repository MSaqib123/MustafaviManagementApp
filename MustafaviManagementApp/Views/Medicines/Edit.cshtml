@model Medicine
@{
    ViewData["Title"] = "Edit Medicine";
}

<h2>Edit Medicine</h2>

<form asp-action="Edit"
      method="post"
      enctype="multipart/form-data">
    <div class="row mb-4">
        <input asp-for="MedicineId" hidden />
        <div class="col-md-4">
            <div class="form-group">
                <label asp-for="MedicineName"></label>
                <input asp-for="MedicineName" class="form-control" />
                <span asp-validation-for="MedicineName" class="text-danger"></span>
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-group">
                <label>Brand</label>
                <select id="ParentCategoryId" class="form-control" asp-for="ParentCategoryId"
                        asp-items="@(ViewBag.ParentCategories as SelectList)">
                    <option value="">-- Select Parent --</option>
                </select>
            </div>
        </div>
        <div class="col-md-4">

            <div class="form-group">
                <label asp-for="CategoryId">Category</label>
                <select asp-for="CategoryId" id="CategoryId" class="form-control">
                    <option value="">-- Select Child --</option>
                </select>
                <span asp-validation-for="CategoryId" class="text-danger"></span>
            </div>
        </div>
        <div class="col-md-4">

            <div class="form-group">
                <label asp-for="StoreId">Store</label>
                <select asp-for="StoreId" class="form-control"
                        asp-items="@(ViewBag.Stores as SelectList)">
                    <option value="">-- Select --</option>
                </select>
                <span asp-validation-for="StoreId" class="text-danger"></span>
            </div>
        </div>
        <div class="col-md-4">

            <div class="form-group">
                <label asp-for="DosageForm"></label>
                <input asp-for="DosageForm" class="form-control" />
            </div>
        </div>
        <div class="col-md-4">

            <div class="form-group">
                <label asp-for="Strength"></label>
                <input asp-for="Strength" class="form-control" />
            </div>
        </div>

        <div class="col-md-4">
            <div class="form-group">
                <label asp-for="ReorderLevel"></label>
                <input asp-for="ReorderLevel" class="form-control" />
            </div>
        </div>
        <div class="col-md-4">

            <div class="form-group">
                <label asp-for="PriceType"></label>
                <select asp-for="PriceType" class="form-control">
                    <option value="SINGLE">Single</option>
                    <option value="COTAN">Cotan</option>
                    <option value="BOTH">Both</option>
                </select>
            </div>
        </div>
        <div class="col-md-4">

            <div class="form-group">
                <label asp-for="SingleUnitPrice"></label>
                <input asp-for="SingleUnitPrice" class="form-control" />
            </div>
        </div>
        <div class="col-md-4">

            <div class="form-group">
                <label asp-for="CotanUnitPrice"></label>
                <input asp-for="CotanUnitPrice" class="form-control" />
            </div>
        </div>
        <div class="col-md-4">

            <div class="form-group">
                <label asp-for="CotanUnitSize"></label>
                <input asp-for="CotanUnitSize" class="form-control" />
            </div>
        </div>
        <!-- Urdu Name -->
        <div class="col-md-4">

            <div class="form-group">
                <label asp-for="UrduName">Urdu Name</label>
                <input asp-for="UrduName" class="form-control" />
            </div>
        </div>

        <!-- Image -->
        <div class="col-md-4">

            <div class="form-group">
                <label asp-for="ImageFile">Picture</label>
                <input asp-for="ImageFile" class="form-control-file" type="file" />
                <span asp-validation-for="ImageFile" class="text-danger"></span>
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-group">
                @if (!string.IsNullOrEmpty(Model.Image))
                {
                    <img src="~/@Model.Image" style="max-height:140px" class="mb-2" />
                }
            </div>
        </div>
    </div>

    <button type="submit" class="btn btn-primary">Update</button>
    <a asp-action="Index" class="btn btn-link">Cancel</a>
</form>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        $(document).ready(function () {
            const categoryId = @Html.Raw(Json.Serialize(Model.CategoryId));
            const parentCategoryId = @Html.Raw(Json.Serialize(Model.ParentCategoryId));

            if (parentCategoryId) {
                loadChildCategories(parentCategoryId, categoryId);
            }

            $('#ParentCategoryId').on('change', function () {
                const parentId = $(this).val();
                $('#CategoryId').empty().append('<option value="">Loading...</option>');
                loadChildCategories(parentId, null);
            });

            function loadChildCategories(parentId, selectedCategoryId) {
                if (!parentId) return;

                $.getJSON(`/Medicines/GetChildCategories?parentId=${parentId}`, function (data) {
                    const $category = $('#CategoryId');
                    $category.empty().append('<option value="">-- Select Child --</option>');

                    $.each(data, function (i, item) {
                        const isSelected = selectedCategoryId && selectedCategoryId == item.value;
                        $category.append(
                            $('<option>', {
                                value: item.value,
                                text: item.text,
                                selected: isSelected
                            })
                        );
                    });
                }).fail(function () {
                    $('#CategoryId').empty().append('<option value="">Failed to load categories</option>');
                });
            }
        });
    </script>

}

