@model MustafaviManagementApp.ViewModels.DashboardViewModel
@using Newtonsoft.Json
@{
    ViewData["Title"] = "Dashboard";

    /* ─── chart JSON ─── */
    var lowStockJson = JsonConvert.SerializeObject(Model.LowStockItems);
    var outStockJson = JsonConvert.SerializeObject(Model.OutOfStockItems);   /* NEW */
    var dailySalesJson = JsonConvert.SerializeObject(Model.DailySales);
    var weeklySalesJson = JsonConvert.SerializeObject(Model.WeeklySales);
    var dailyPurchJson = JsonConvert.SerializeObject(Model.DailyPurchases);
    var weeklyPurchJson = JsonConvert.SerializeObject(Model.WeeklyPurchases);

    /* ─── quick numbers ─── */
    var totalEver = Model.TotalStock;
    var onHand = Model.RemainingStock;
    var lowSkuCount = Model.LowStockItems.Count;
    var outSkuCount = Model.OutOfStockItems.Count;                            /* NEW */
    var totalRevenue = Model.Revenue;

    string curPeriod = ViewBag.Period ?? "daily";
}

<!--  FontAwesome -->
<link href="~/lib/font-awesome/all.css" rel="stylesheet" />
<script src="~/lib/font-awesome/all.js"></script>

<!--  DataTables (Bootstrap 5)  -->
<link href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>

<!--  Highcharts  -->
<script src="~/lib/highcharts/highcharts.js"></script>

<style>
    .stat-card {
        border-radius: .75rem;
        box-shadow: 0 4px 16px rgba(0,0,0,.1);
        transition: transform .2s
    }

        .stat-card:hover {
            transform: translateY(-4px)
        }

    .chart-card {
        border-radius: .75rem;
        box-shadow: 0 4px 16px rgba(0,0,0,.05);
        padding: 1rem;
        background: #fff
    }
</style>

<div class="container py-4">

    <!-- selector -->
    <div class="row align-items-center mb-5">
        <!-- centred heading -->
        <div class="col text-center">
            <h2 class="fw-bold m-0">📊 Mustafavi Management System</h2>
        </div>

        <!-- dropdown stuck to the far right -->
        <div class="col-auto text-end">
            <select id="periodSel"
                    class="form-select w-auto"
                    onchange="location.href='@Url.Action("Index","Home")?period=' + this.value">
                <option value="daily" selected="@(curPeriod=="daily")">Daily</option>
                <option value="weekly" selected="@(curPeriod=="weekly")">Weekly</option>
                <option value="monthly" selected="@(curPeriod=="monthly")">Monthly</option>
                <option value="yearly" selected="@(curPeriod=="yearly")">Yearly</option>
                <option value="last5" selected="@(curPeriod=="last5")">Last 5 Years</option>
            </select>
        </div>
    </div>


    

    <!-- ░░ STAT CARDS ░░ -->
    <div class="row g-4 mb-5 justify-content-center align-items-center">
        <div class="col-6 col-md-2">
            <div class="stat-card bg-primary text-white text-center py-3">
                <i class="fas fa-boxes fa-2x mb-2"></i>
                <h6>Total Ever Added</h6><h4>@totalEver</h4>
            </div>
        </div>
        <div class="col-6 col-md-2">
            <div class="stat-card bg-success text-white text-center py-3">
                <i class="fas fa-warehouse fa-2x mb-2"></i>
                <h6>Currently On-hand</h6><h4>@onHand</h4>
            </div>
        </div>
        <div class="col-6 col-md-2">
            <div class="stat-card bg-warning text-dark text-center py-3">
                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                <h6>Low-stock SKUs</h6><h4>@lowSkuCount</h4>
            </div>
        </div>
        <!-- NEW out-of-stock card -->
        <div class="col-6 col-md-2">
            <div class="stat-card bg-danger text-white text-center py-3">
                <i class="fas fa-ban fa-2x mb-2"></i>
                <h6>Out of Stock</h6><h4>@outSkuCount</h4>
            </div>
        </div>
        <div class="col-6 col-md-2">
            <div class="stat-card bg-info text-white text-center py-3">
                <i class="fas fa-dollar-sign fa-2x mb-2"></i>
                <h6>Total Revenue</h6><h4>@totalRevenue.ToString("N0")</h4>
            </div>
        </div>
    </div>

    <!-- ░░ CHART GRID ░░ -->
    <div class="row g-4">

        <div class="col-lg-6">
            <div class="chart-card h-100">
                <h5 class="mb-3">Total Stock vs Remaining</h5>
                <div id="stock-pie" style="height:350px"></div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="chart-card h-100">
                <h5 class="mb-3">Low-stock Items &lt;5</h5>
                <div id="low-stock-bar" style="height:350px"></div>
            </div>
        </div>

        <!-- NEW out-of-stock bar -->
        <div class="col-lg-6">
            <div class="chart-card h-100">
                <h5 class="mb-3">Out-of-Stock SKUs</h5>
                <div id="out-stock-bar" style="height:350px"></div>
            </div>
        </div>

        <!-- existing conditional charts -->
        @if (Model.DailySales.Any())
        {
            <div class="col-lg-6"><div class="chart-card h-100"><h5 class="mb-3">Sales (@curPeriod)</h5><div id="daily-sales" style="height:350px"></div></div></div>
        }
        @if (Model.WeeklySales.Any())
        {
            <div class="col-lg-6"><div class="chart-card h-100"><h5 class="mb-3">Weekly Sales</h5><div id="weekly-sales" style="height:350px"></div></div></div>
        }
        @if (Model.DailyPurchases.Any())
        {
            <div class="col-lg-6"><div class="chart-card h-100"><h5 class="mb-3">Purchases (@curPeriod)</h5><div id="daily-purchases" style="height:350px"></div></div></div>
        }
        @if (Model.WeeklyPurchases.Any())
        {
            <div class="col-lg-6"><div class="chart-card h-100"><h5 class="mb-3">Weekly Purchases</h5><div id="weekly-purchases" style="height:350px"></div></div></div>
        }

        <div class="col-6">
            <div class="chart-card">
                <h5 class="mb-3">Inventory Value vs Revenue</h5>
                <div id="values-column" style="height:400px"></div>
            </div>
        </div>
    </div>

    <!-- ░░ OUT-OF-STOCK DATATABLE ░░ -->
    <div class="row g-4 mt-3">
        <div class="col-12">
            <div class="chart-card">
                <h5 class="mb-3">Detailed Out-of-Stock List</h5>
                <table id="outStockTbl" class="table table-striped table-bordered table-sm nowrap" style="width:100%">
                    <thead class="table-light"><tr><th>Medicine</th><th class="text-end">Qty</th></tr></thead>
                    <tbody>
                        @foreach (var o in Model.OutOfStockItems)
                        {
                            <tr class="table-danger"><td>@o.MedicineName</td><td class="text-end">0</td></tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        /* ========== DATA ========== */
        const lowStock   = @Html.Raw(lowStockJson);
        const outStock   = @Html.Raw(outStockJson);      /* NEW */
        const dailySales = @Html.Raw(dailySalesJson);
        const weeklySales= @Html.Raw(weeklySalesJson);
        const dailyPurch = @Html.Raw(dailyPurchJson);
        const weeklyPurch= @Html.Raw(weeklyPurchJson);
        const totalStock = @Model.TotalStock;
        const remain     = @Model.RemainingStock;
        const invVals    = { total:@Model.TotalInventoryValue, remaining:@Model.RemainingInventoryValue, revenue:@Model.Revenue };

        const cat  = a=>a.map(p=>p.Period);
        const data = a=>a.map(p=>p.Value);

        /* ========== CHARTS ========== */
        Highcharts.chart('stock-pie',{chart:{type:'pie'},title:{text:''},
          series:[{name:'Units',data:[{name:'Total added',y:totalStock},{name:'On-hand',y:remain}]}],
          credits:{enabled:false}});

        Highcharts.chart('low-stock-bar',{chart:{type:'column'},title:{text:''},
          xAxis:{categories:lowStock.map(x=>x.MedicineName)},yAxis:{title:{text:'Units'}},
          series:[{name:'Qty',data:lowStock.map(x=>x.Quantity)}],credits:{enabled:false}});

        /* NEW Out-of-stock bar (dummy value=1 for visibility) */
        Highcharts.chart('out-stock-bar',{
          chart:{type:'column'},title:{text:''},
          xAxis:{categories:outStock.map(x=>x.MedicineName)},
          yAxis:{title:{text:' '},min:0},
          tooltip:{pointFormatter(){return `<span style="color:#dc3545">\u25CF</span> Qty <b>0</b>`}},
          plotOptions:{series:{minPointLength:5}},              // force visible bar
          series:[{name:'Out',color:'#dc3545',data:outStock.map(()=>1)}],
          credits:{enabled:false}
        });

        function makeLine(div,title,series){
          if(!series.length) return;
          Highcharts.chart(div,{chart:{type:'line'},title:{text:''},
            xAxis:{categories:cat(series)},yAxis:{title:{text:'PKR'}},
            series:[{name:title,data:data(series)}],credits:{enabled:false}});
        }
        makeLine('daily-sales','Sales',dailySales);
        makeLine('weekly-sales','Sales',weeklySales);
        makeLine('daily-purchases','Purchases',dailyPurch);
        makeLine('weekly-purchases','Purchases',weeklyPurch);

        Highcharts.chart('values-column',{chart:{type:'column'},title:{text:''},
          xAxis:{categories:['Total Purchase Cost','Remaining Inventory','Revenue']},
          yAxis:{title:{text:'PKR'}},
          series:[{name:'Amount',data:[invVals.total,invVals.remaining,invVals.revenue]}],
          credits:{enabled:false}});

        /* ========== DATATABLE ========== */
        $(function(){
          $('#outStockTbl').DataTable({
            responsive:true,pageLength:10,lengthMenu:[5,10,25,50,100],
            columnDefs:[{targets:1,className:'text-end'}],
            language:{search:"",searchPlaceholder:"Search…"}
          });
        });
    </script>
}
