@{
    ViewData["Title"] = "Advanced Stock Ledger Report";
}

<!-- ───── CSS / JS CDN ───── -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.datatables.net/1.13.10/css/dataTables.bootstrap5.min.css" rel="stylesheet" />

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.10/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.10/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* رنگ کوڈنگ */
    .qty-pos {
        color: #198754
    }
    /* + */
    .qty-neg {
        color: #dc3545
    }
    /* – */
</style>

<h1 class="mb-4">Stock Ledger – Advanced Report</h1>

<!-- ───────────── Filter Form ───────────── -->
<form id="filterForm" class="row g-2 align-items-end mb-3" method="get">
    <div class="col-md-2">
        <label class="form-label fw-bold">Date From</label>
        <input name="dateFrom" type="date" class="form-control" />
    </div>
    <div class="col-md-2">
        <label class="form-label fw-bold">Date To</label>
        <input name="dateTo" type="date" class="form-control" />
    </div>
    <div class="col-md-3">
        <label class="form-label fw-bold">Medicine</label>
        @Html.DropDownList("medicineId", (SelectList)ViewBag.Medicines, "ALL",
                 new { @class = "form-select" })
    </div>
    <div class="col-md-2">
        <label class="form-label fw-bold">Action</label>
        @Html.DropDownList("actionType", (SelectList)ViewBag.ActionTypes, null,
                 new { @class = "form-select" })
    </div>
    <div class="col-md-auto">
        <button class="btn btn-primary w-100">Filter</button>
    </div>
    <div class="col-md-auto">
        <a id="btnExcel" class="btn btn-success w-100" target="_blank">Excel</a>
    </div>
    <div class="col-md-auto">
        <a id="btnCsv" class="btn btn-secondary w-100" target="_blank">CSV</a>
    </div>
</form>

<!-- ───────────── Totals ───────────── -->
<div class="mb-3">
    <span class="badge bg-success">IN: <span id="sumIn">0</span></span>
    <span class="badge bg-danger">OUT: <span id="sumOut">0</span></span>
    <span class="badge bg-warning text-dark">RESERVE: <span id="sumRes">0</span></span>
    <span class="badge bg-info text-dark">RELEASE: <span id="sumRel">0</span></span>
</div>

<!-- ───────────── Chart ───────────── -->
<canvas id="ioChart" height="120" class="mb-4 border rounded p-2"></canvas>

<!-- ───────────── DataTable ───────────── -->
<table id="ledgerTable" class="table table-striped table-bordered w-100">
    <thead class="table-light">
        <tr>
            <th>Date&nbsp;Time</th>
            <th>Medicine</th>
            <th>Action</th>
            <th class="text-end">Δ&nbsp;Qty</th>
            <th class="text-end">Balance</th>
            <th>SaleId</th>
            <th>PurchaseId</th>
        </tr>
    </thead>
</table>

<!-- ───────────── JS Logic ───────────── -->
<script>
    $(function(){

        /* utility: convert form → flat object */
        const formObj = () =>
            $('#filterForm').serializeArray()
              .reduce((o,i)=>{o[i.name]=i.value;return o;}, {});

        /* ===== DataTable ===== */
        const table = $('#ledgerTable').DataTable({
            serverSide:true, processing:true,
            lengthMenu:[25,50,100],
            ajax:{
                url : '@Url.Action("DataTable", "AdvancedStockLedgerReports")',
                type: 'GET',                 // CSRF free
                data: function(d){ return $.extend({}, d, formObj()); }
            },
            columns:[
              {data:'date'},
              {data:'medicine'},
              {data:'action'},
              {data:'qtyChange',
                render:d=> d<0
                    ? `<span class="qty-neg">${d}</span>`
                    : `<span class="qty-pos">+${d}</span>`,
                className:'text-end'},
              {data:'balance',className:'text-end'},
              {data:'saleId'},
              {data:'purchaseId'}
            ],
            order:[[0,'desc']]
        });

        /* ===== Summary ===== */
        function loadSummary(){
            $.get('@Url.Action("Summary", "AdvancedStockLedgerReports")',
                  formObj(), list=>{
                const find=k=>list.find(x=>x.action===k)?.qty||0;
                $('#sumIn').text(find('IN')+find('ADJUST_IN'));
                $('#sumOut').text(-(find('OUT')+find('ADJUST_OUT')+find('SCRAP_OUT')));
                $('#sumRes').text(-find('RESERVE'));
                $('#sumRel').text(find('RELEASE'));
            });
        }

        /* ===== Chart ===== */
        const chart = new Chart(document.getElementById('ioChart'),{
            type:'bar',
            data:{labels:[],datasets:[
              {label:'IN',backgroundColor:'#198754',data:[]},
              {label:'OUT',backgroundColor:'#dc3545',data:[]}
            ]},
            options:{responsive:true}
        });
        function loadChart(){
            $.get('@Url.Action("Chart", "AdvancedStockLedgerReports")',
                  formObj(), d=>{
                chart.data.labels = d.labels;
                chart.data.datasets[0].data = d.inData;
                chart.data.datasets[1].data = d.outData;
                chart.update();
            });
        }

        /* ===== Export links ===== */
        function refreshLinks(){
            const qs = $.param(formObj());
            $('#btnExcel').attr('href',
                '@Url.Action("ExportExcel", "AdvancedStockLedgerReports")?'+qs);
            $('#btnCsv').attr('href',
                '@Url.Action("ExportCsv", "AdvancedStockLedgerReports")?'+qs);
        }

        /* ===== Filter submit ===== */
        $('#filterForm').on('submit',function(e){
            e.preventDefault();
            table.ajax.reload();
            loadSummary();
            loadChart();
            refreshLinks();
        });

        /* initial load */
        loadSummary(); loadChart(); refreshLinks();
    });
</script>
